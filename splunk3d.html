<html>
  <!-- DronesoundTV (ThreeJS) / Splunk SDK mashup
       Largely based on SDK examples
       Memo: 3D features from js/splunkland-3d.js include:

       fnSkybox (argPrefix)             // Set skybox by prefix
       fnAddCube (argX, argY, argZ, argSize, argTextureURL)
       fnAddSphere (argX, argY, argZ, argRadius, argTextureURL)
       fnAddPlane (argX, argY, argZ, argSize, argXRot, argYRot, argTextureURL)
       fnMakeText (argFontURL, argText, argX, argY, argZ)
       fnAddPointLight (argPos, argColor)
       fnCamSet (argX, argY, argZ)      // Set next cam look target
       fnCam (argPos)                   // Tween to rand cam target or next

       Set object by name (default name is "x y z" pos)
       fnObjectName (argName)

       Create a pulsing "user cursor"
       fnUserCursor (argX, argY, argZ, argUserName)

       Dev/incomplete/janky: Add cube with inline image id=media as texture:
       fnMediaCube (argX, argY, argZ, argSize, argTextureURL)
       Prune oldest prims if over limit
       fnPrimLimit () 
       fnPrimDelete (argPos)     // Delete by "x y z" pos arg string
       fnDeleteByName (argName)  // Delete by name
       fnObjectMove (argName, argX, argY, argZ)

       Load a (.json) model from mod_sandbox/models:
       fnLoadModel (argName, argX, argY, argZ)

  -->
  <head>
    <meta charset="utf-8">
    <title>Splunk3d Prototype</title>

    <!-- Jquery required for SplunkSDK and our own Ajax -->
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <!-- Alt:
      src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"
    -->
    <!-- Splunk JS SDK -->
    <script type="text/javascript" src="client/splunk.js"></script>

    <!-- Three.js support (see also: 3d.js must load in body) -->
    <script type="text/javascript" src="js/three.min.js"></script>
    <script type="text/javascript" src="js/GeometryUtils.js"></script>
    <script type="text/javascript" src="js/Tween.js"></script>

    <!-- Was: 3D controller ala DronesoundTV -->
    <script type="text/javascript">
      // Splunk.js helper objects
      var Async = splunkjs.Async;
      var utils = splunkjs.Utils;
      var sBuffer = "";
      var iDebug = false;         // Onscreen debug enable

      // Dev-only hardwired 3D/graphic assets
      var sTexturePath = "images/textures/";
      var aTextures = ["orange", "indigo", "yellow", "green", "lava"];
      var iTextureCount = aTextures.length;
      // var sSkyboxPath = "images/skyboxes/";
      var aSkyboxes   = ["alps", "arrakisday", "mainframe", 
        "met", "moondust", "mp_portal", "nightsky", "test"];
      var iSkyboxCount = aSkyboxes.length;

      // Simple logging feature
      function fnLog (argString) {
        console.log ("Controller: " + argString);
      }

      // Output buffer/displayer/logger in one
      // Pass empty string to clear-out
      function fnOutput (argString) {
        if (argString.length == 0) {   // To clear buffer
          sBuffer = "";
        } else {
          sBuffer += argString;
         fnLog (argString);
        }
        $("#uiTextOut").html(sBuffer); // Update (or clear)
      }

      // -------------------------------
      // Simple 3D Tests
      // -------------------------------
      // Broken?
      // fnMakeText ("assets/droid_serif_regular.typeface.json", "X", iX, iY, 0);

      // 3D spam. Remember, fnAddCube pre-deletes any existing at same pos
      function fn3DTest (iArgMode) {
        var sT;
        fnCam (0, 600, 1000);         // Look at this pos
        for (var iX = -1600; iX < 1600; iX += 900) {
          for (var iY = -800; iY < 2200; iY += 900) {
            sT = sTexturePath 
              + aTextures[Math.floor(Math.random() * iTextureCount)]
              + ".png"; 
            // fnAddCube syntax: x y z size texture_url
            fnAddCube (iX, iY, 1600, 250, sT);
          }                           // End for
        }                             // End for
      }                               // End 3D test function

      function fnSkyboxRand () {
        fnSkybox (aSkyboxes[Math.floor(Math.random() * iSkyboxCount)]);
      }

      // Generate 3D prim with properties based on argSeed,
      // producing unique visual object for each type of data
      function fnGenerateObject (argSeed) {
        //
        //  INSERT CODE:
        //        Create rng with Alea (argSeed)
        // var oRNG = new alea (argSeed);
        //        create properties for 
        //          Texture, type (sphere, cube) and size
        //
        // var sT = sTexturePath 
        //   + aTextures[Math.floor(oRNG() * iTextureCount)]
        //   + ".png"; 
        //
        // var fSize = oRNG() * 40 + 10;         // Range 10-50
        //
        // var iType = Math.floor (oRNG() * 2);  // Only two now
        // if (iType == 0) {
        //     // Make cube
        //     fnAddCube (iX, iY, 1600, 250, sT);
        //     // Name it
        // }
        // else {
        //   // Make sphere
        // }
        // 
        // Set object name (so can delete later)
        // return (sObjectName);
        //
      }

    </script>
    <!-- End 3D controller code -->

    <!-- Splunk App code (largely from examples) -->
    <script type="text/javascript" charset="utf-8">
      var oSplunkProxy = null;        // Glob proxy to Splunk
      var oSplunkService = null;      // Splunk connection service
      // Default Splunk search syntax
      // Note: Omits "search" so matches SplunkWeb
      // og // var sSPL = "search index=_internal | head 3";
      var sSearchPrefix = "search ";  // Pre-pended later
      var sSPL = "index=_internal | head 3";
  
      // Smrt Splunk connect handler: 
      // Create proxy/connection only if needed
      function fnConnect () {
        if (oSplunkProxy == null || oSplunkService == null) {
          console.log ("fnConnect: Connecting to Splunk via JS proxy...");
  
          // Tunnel requests through splunkjs proxy cause Single Origin Policy
          oSplunkProxy = new splunkjs.ProxyHttp ("/proxy");
  
          // Create a Service instance and log in 
          oSplunkService = new splunkjs.Service (oSplunkProxy, {
            username: "splunksdk",   // WARN: Hardwired creds
            password: "splunksdk",
            scheme: "https",
            host: "localhost",
            port:"8089",             // Splunkd port (NOT splunk web)
            version:"5.0"
          });
          console.log ("fnConnect: Splunk connected, maybe.");
        } else {
          console.log ("fnConnect: Splunk already connected.");
        }                            // End if proxy/service
      }                              // End fnConnect
  
      // From example code: List apps (assume connected already)
      function fnDisplayApps() {
        fnOutput ("");               // Clear output buffer/ui
        fnConnect();                 // Connect Splunk if necessary

        // Print installed apps to the console
        // Provide apps().fetch an anonymous callback w/err handler 
        oSplunkService.apps().fetch (function(err, argApps) {
          if (err) {                 // Ditch on error
            fnOutput ("");
            fnOutput ("Splunk Service: Error listing apps");
            return;
          }

          // Else, iterate apps and stuff into document
          var sApps = "";
          var oAppsList = argApps.list();
          for(var i=0; i < oAppsList.length; i++) {
            sApps += oAppsList[i].name + " "
          } 
          fnOutput(sApps);
        });                           // End anon fetch callback

      }                               // End function

      // Example one-off splunk search, based on
      // http://localhost:6969/examples/browser/helloworld/index.html
      // To do: Handle connect errors, convert to non-Async chain
      function fnSplunkSearch () {
        fnOutput ("");                // Clear output buffer/ui
        fnConnect();                  // Connect if necessary

        // Get search syntax from UI (to do: minimal validation?)
        if ($("#uiTextIn").val().length) { 
          sSPL = $("#uiTextIn").val();
        }

        fnOutput ("Executing: " + sSPL +  "<br>One moment...");

        Async.chain ([                // Entire transaction as async chain

          function (done) {           // Handle error, initiate search
            // if (!success) {        // To do, handle errors
            //   fnLog ("Error logging in"); // done("Error logging in");
            // }
            oSplunkService.search (sSearchPrefix + sSPL, {}, done);
          },

          // Wait until the job is done
          function (argJob, done) {
            Async.whilst (                  // Loop till done
              function() { return !argJob.properties().isDone; },

              // Refresh the job on every iteration, but sleep for 1 second
              function (iterationDone) {
                Async.sleep (1000, function() {       // 1s delay
                  // Refresh job, noting how many events so far
                  argJob.fetch (function(err) {
                    fnOutput ("Fetching: " 
                      + (argJob.properties().eventCount || 0) 
                      + " events searched");
                    iterationDone();
                  });                        // End argJob.fetch anon callback func
                });                          // End async sleep delay func
              },                             // End async whilst anon callback func

              // When done, pass the job forward
              function (err) {
                fnOutput ("Search: job done");
                done (err, argJob);
              }
            );                               // End async whilst
          },                                 // End anon func "wait till job done"

          // Search done, print stats and retrieve results
          function (argJob, done) {
            fnOutput ("");                   // Clear output
            fnOutput ("Search job statistics: ");
            fnOutput (" Count: " + argJob.properties().eventCount);
            fnOutput (" Disk: " + argJob.properties().diskUsage + " bytes");
            fnOutput (" Priority: " + argJob.properties().priority);
            argJob.results({}, done);        // Request results
          },

          function (results, job, done) {    // Show raw results
            // Find the index of the fields we want
            var rawIndex        = utils.indexOf(results.fields, "_raw");
            var kvIndex        = utils.indexOf(results.fields, "_kv");
            var sourcetypeIndex = utils.indexOf(results.fields, "sourcetype");
            // var userIndex       = utils.indexOf(results.fields, "user");

            fnOutput ("<br>Fields in results: " + results.fields);
            fnOutput ("<br>----------------------------------<br>");

            // Handle individual result rows
            for (var i = 0; i < results.rows.length; i++) {
              // fnOutput ("Result " + i + ": ");
              fnOutput ("Sourcetype: " + results.rows[i][sourcetypeIndex] + " | ");
              // fnOutput (" User: " + results.rows[i][userIndex]);
              // fnOutput (" KV Pairs: " + results.rows[i][kvIndex]);
              fnOutput (" Raw: " + results.rows[i][rawIndex]);
              fnOutput ("<br>");
            }
            
            job.cancel(done);                // When done, cancel job
          }                                  // End print results anon func
        ],                                   // End async function array

        function (err) {fnCallback(err);}    // Async error handler
        );                                   // End async, finally

      }                                      // End fnRealTimeSearch function

      // Handle Async callbacks (generally, errors)
      function fnCallback (argMsg) {
        fnLog ("Callback receieved: " + argMsg);
      }

    </script>
    <!-- End Splunk app code -->

    <!-- Alea seedable prng, courtesy of ___________ 
      Example:
         var arng = new alea('hello.');
         console.log(arng());    // Always 0.4783254903741181
    -->
  <script>
    !function(n,t,e){function o(n){var s,t=this,e=(s=4022871197,function(n){n=n.toString();for(var t=0;t<n.length;t++){var e=.02519603282416938*(s+=n.charCodeAt(t));e-=s=e>>>0,s=(e*=s)>>>0,s+=4294967296*(e-=s)}return 2.3283064365386963e-10*(s>>>0)});t.next=function(){var n=2091639*t.s0+2.3283064365386963e-10*t.c;return t.s0=t.s1,t.s1=t.s2,t.s2=n-(t.c=0|n)},t.c=1,t.s0=e(" "),t.s1=e(" "),t.s2=e(" "),t.s0-=e(n),t.s0<0&&(t.s0+=1),t.s1-=e(n),t.s1<0&&(t.s1+=1),t.s2-=e(n),t.s2<0&&(t.s2+=1),e=null}function u(n,t){return t.c=n.c,t.s0=n.s0,t.s1=n.s1,t.s2=n.s2,t}function s(n,t){var e=new o(n),s=t&&t.state,r=e.next;return r.int32=function(){return 4294967296*e.next()|0},r.double=function(){return r()+11102230246251565e-32*(2097152*r()|0)},r.quick=r,s&&("object"==typeof s&&u(s,e),r.state=function(){return u(e,{})}),r}t&&t.exports?t.exports=s:e&&e.amd?e(function(){return s}):this.alea=s}(0,"object"==typeof module&&module,"function"==typeof define&&define);
  </script>

</head>

<body>
  <!-- On document ready, init some fields -->
  <script type="text/javascript">
    $(document).ready(function() {$("#uiTextIn").val(sSPL);});
  </script>

  <!-- User interface -->
  <div id="controls" style="width:100%; margin-bottom:1em;">
    <!-- Dev testing UI -->
    <button type="button" onClick="fnSkyboxRand();">Skybox</button>
    <button type="button" onClick="fn3DTest();">3D Spam</button>
    <button type="button" onClick="fnDisplayApps();">List apps</button>
    <button type="button" onClick="fnSplunkSearch();">Splunk Search</button>
  </div>

  <span>Input</span>
  <input id="uiTextIn" type="text" size="48">

  <p id="uiTextOut" style="font-size:0.8em;"></p>      <!-- Text output element -->

  <!-- ThreeJS does all 3D in threejs div 
       Note: 3D canvas size set by fnInit in splunkland-3d.js
  -->
  <div id="threejs"
       style="top:0; left:0; padding:0;">
  </div>  
  <!-- All 3d implemented in 3d.js (MUST load in body)
       Note splunkland-3d.js:fnInit() called on load (see its mainline)
  -->
  <script type="text/javascript" src="js/splunkland-3d.js"></script>

</body>
</html>
